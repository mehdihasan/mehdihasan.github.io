<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8" data-next-head=""/><title data-next-head="">Fixing Concurrent Queries Within the Same Session in ClickHouse Async Python Apps (Uvicorn + FastAPI) | BetweenSystems</title><meta name="description" content="
Connecting to a database from Python seems simple enough - you create a client, send queries, and handle results. But when we scaled that to thousands of concu" data-next-head=""/><meta name="keywords" content="Python, ClickHouse, Uvicorn, Concurrency, Architecture, DevOps" data-next-head=""/><meta name="author" content="BetweenSystems" data-next-head=""/><meta name="robots" content="index,follow" data-next-head=""/><meta name="googlebot" content="index,follow" data-next-head=""/><meta http-equiv="content-language" content="en" data-next-head=""/><meta name="language" content="en" data-next-head=""/><link rel="canonical" href="https://betweensystems.com/fixing-concurrent-queries-within-the-same-session-in-clickHouse-async-python-apps" data-next-head=""/><meta property="og:type" content="article" data-next-head=""/><meta property="og:title" content="Fixing Concurrent Queries Within the Same Session in ClickHouse Async Python Apps (Uvicorn + FastAPI) | BetweenSystems" data-next-head=""/><meta property="og:description" content="
Connecting to a database from Python seems simple enough - you create a client, send queries, and handle results. But when we scaled that to thousands of concu" data-next-head=""/><meta property="og:image" content="https://betweensystems.com/images/ch1/cover.jpg" data-next-head=""/><meta property="og:image:width" content="1200" data-next-head=""/><meta property="og:image:height" content="630" data-next-head=""/><meta property="og:image:alt" content="Fixing Concurrent Queries Within the Same Session in ClickHouse Async Python Apps (Uvicorn + FastAPI) | BetweenSystems" data-next-head=""/><meta property="og:url" content="https://betweensystems.com/fixing-concurrent-queries-within-the-same-session-in-clickHouse-async-python-apps" data-next-head=""/><meta property="og:site_name" content="BetweenSystems" data-next-head=""/><meta property="og:locale" content="en_US" data-next-head=""/><meta property="article:author" content="BetweenSystems" data-next-head=""/><meta property="article:section" content="Travel &amp; Technology" data-next-head=""/><meta property="article:published_time" content="2025-10-16T00:00:00.000Z" data-next-head=""/><meta property="article:tag" content="Python" data-next-head=""/><meta property="article:tag" content="ClickHouse" data-next-head=""/><meta property="article:tag" content="Uvicorn" data-next-head=""/><meta property="article:tag" content="Concurrency" data-next-head=""/><meta property="article:tag" content="Architecture" data-next-head=""/><meta property="article:tag" content="DevOps" data-next-head=""/><meta name="twitter:card" content="summary_large_image" data-next-head=""/><meta name="twitter:title" content="Fixing Concurrent Queries Within the Same Session in ClickHouse Async Python Apps (Uvicorn + FastAPI) | BetweenSystems" data-next-head=""/><meta name="twitter:description" content="
Connecting to a database from Python seems simple enough - you create a client, send queries, and handle results. But when we scaled that to thousands of concu" data-next-head=""/><meta name="twitter:image" content="https://betweensystems.com/images/ch1/cover.jpg" data-next-head=""/><meta name="twitter:image:alt" content="Fixing Concurrent Queries Within the Same Session in ClickHouse Async Python Apps (Uvicorn + FastAPI) | BetweenSystems" data-next-head=""/><meta name="twitter:site" content="@betweensystems" data-next-head=""/><meta name="twitter:creator" content="@betweensystems" data-next-head=""/><meta name="viewport" content="width=device-width, initial-scale=1.0" data-next-head=""/><meta name="theme-color" content="#00ABE4" data-next-head=""/><meta name="msapplication-TileColor" content="#00ABE4" data-next-head=""/><meta name="msapplication-navbutton-color" content="#00ABE4" data-next-head=""/><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" data-next-head=""/><meta name="geo.region" content="NO" data-next-head=""/><meta name="geo.placename" content="Norway" data-next-head=""/><meta name="ICBM" content="60.472024, 8.468946" data-next-head=""/><link rel="icon" href="/betweensystems/favicon.ico" data-next-head=""/><link rel="apple-touch-icon" sizes="180x180" href="/betweensystems/apple-touch-icon.png" data-next-head=""/><link rel="icon" type="image/png" sizes="32x32" href="/betweensystems/favicon-32x32.png" data-next-head=""/><link rel="icon" type="image/png" sizes="16x16" href="/betweensystems/favicon-16x16.png" data-next-head=""/><link rel="manifest" href="/site.webmanifest" data-next-head=""/><script type="application/ld+json" data-next-head="">{"@context":"https://schema.org","@type":"BlogPosting","headline":"Fixing Concurrent Queries Within the Same Session in ClickHouse Async Python Apps (Uvicorn + FastAPI)","description":"\nConnecting to a database from Python seems simple enough - you create a client, send queries, and handle results. But when we scaled that to thousands of concu","image":{"@type":"ImageObject","url":"https://betweensystems.com/images/ch1/cover.jpg","width":1200,"height":630},"datePublished":"2025-10-16T00:00:00.000Z","dateModified":"2025-10-16T00:00:00.000Z","author":{"@type":"Person","name":"BetweenSystems","url":"https://betweensystems.com"},"publisher":{"@type":"Organization","name":"BetweenSystems","logo":{"@type":"ImageObject","url":"https://betweensystems.com/betweensystems/logo.svg","width":200,"height":200}},"mainEntityOfPage":{"@type":"WebPage","@id":"https://betweensystems.com/fixing-concurrent-queries-within-the-same-session-in-clickHouse-async-python-apps"},"keywords":"Python, ClickHouse, Uvicorn, Concurrency, Architecture, DevOps","inLanguage":"en-US","wordCount":1929,"articleSection":"Technology"}</script><link rel="preconnect" href="https://fonts.googleapis.com" data-next-head=""/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous" data-next-head=""/><link rel="preconnect" href="https://firestore.googleapis.com" data-next-head=""/><link rel="dns-prefetch" href="//fonts.googleapis.com" data-next-head=""/><link rel="dns-prefetch" href="//firestore.googleapis.com" data-next-head=""/><link rel="dns-prefetch" href="//github.com" data-next-head=""/><link rel="alternate" type="application/rss+xml" title="BetweenSystems RSS Feed" href="/feed.xml" data-next-head=""/><link rel="alternate" type="application/atom+xml" title="BetweenSystems Atom Feed" href="/atom.xml" data-next-head=""/><meta name="copyright" content="Â© 2025 BetweenSystems" data-next-head=""/><meta name="rating" content="General" data-next-head=""/><meta name="distribution" content="Global" data-next-head=""/><link rel="me" href="https://github.com/betweensystems" data-next-head=""/><link rel="preload" href="/images/ch1/cover.jpg" as="image" data-next-head=""/><link rel="icon" href="/favicon.ico"/><link rel="preload" href="/_next/static/css/b60c7510b0bb27b3.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b60c7510b0bb27b3.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-42372ed130431b0a.js"></script><script src="/_next/static/chunks/webpack-6224d37324e372cb.js" defer=""></script><script src="/_next/static/chunks/framework-1ce91eb6f9ecda85.js" defer=""></script><script src="/_next/static/chunks/main-5f753c8e2e8f516e.js" defer=""></script><script src="/_next/static/chunks/pages/_app-0dc41225bd148ead.js" defer=""></script><script src="/_next/static/chunks/578-2489efa08bf3c2ca.js" defer=""></script><script src="/_next/static/chunks/820-6546bf980e890cb7.js" defer=""></script><script src="/_next/static/chunks/437-41698d1bb557b584.js" defer=""></script><script src="/_next/static/chunks/pages/%5Bslug%5D-e3b3c9c45de82d74.js" defer=""></script><script src="/_next/static/p3erRfV6NL6EPM2TJwJwU/_buildManifest.js" defer=""></script><script src="/_next/static/p3erRfV6NL6EPM2TJwJwU/_ssgManifest.js" defer=""></script><style id="__jsx-88212ac20c106742">*:focus-visible{outline:2px solid#00ABE4;outline-offset:2px}@media(prefers-reduced-motion:reduce){*,*::before,*::after{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important}}@media(prefers-contrast:high){.MuiButton-root{border:2px solid currentColor}}@media print{.no-print{display:none!important}body{background:white!important;color:black!important}}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}.skip-to-main{position:absolute;top:-40px;left:8px;background:#00ABE4;color:white;padding:8px 16px;text-decoration:none;border-radius:4px;z-index:9999;transition:top.3s ease}.skip-to-main:focus{top:8px}</style><style id="__jsx-96dff90f108e4eed">@keyframes heartbeat{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}</style></head><body><div id="__next"><style data-emotion="css-global njgabe">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#f5f7fa;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#f5f7fa;}</style><style data-emotion="css 2d1fge">.css-2d1fge{-webkit-text-decoration:underline;text-decoration:underline;text-decoration-color:var(--Link-underlineColor);--Link-underlineColor:rgba(0, 171, 228, 0.4);position:absolute;top:-40px;left:8px;background-color:#00ABE4;color:rgba(0, 0, 0, 0.87);padding:8px 16px;border-radius:4px;-webkit-text-decoration:none;text-decoration:none;z-index:9999;-webkit-transition:top 0.3s ease;transition:top 0.3s ease;}.css-2d1fge:hover{text-decoration-color:inherit;}.css-2d1fge:focus{top:8px;}</style><style data-emotion="css ssbdn6">.css-ssbdn6{margin:0;font:inherit;line-height:inherit;letter-spacing:inherit;color:#00ABE4;-webkit-text-decoration:underline;text-decoration:underline;text-decoration-color:var(--Link-underlineColor);--Link-underlineColor:rgba(0, 171, 228, 0.4);position:absolute;top:-40px;left:8px;background-color:#00ABE4;color:rgba(0, 0, 0, 0.87);padding:8px 16px;border-radius:4px;-webkit-text-decoration:none;text-decoration:none;z-index:9999;-webkit-transition:top 0.3s ease;transition:top 0.3s ease;}.css-ssbdn6:hover{text-decoration-color:inherit;}.css-ssbdn6:focus{top:8px;}</style><a class="MuiTypography-root MuiTypography-inherit MuiLink-root MuiLink-underlineAlways css-ssbdn6" href="#main-content">Skip to main content</a><style data-emotion="css 1qcz9d3">.css-1qcz9d3{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:-webkit-sticky;position:sticky;z-index:1100;top:0;left:auto;right:0;--AppBar-background:#00ABE4;--AppBar-color:rgba(0, 0, 0, 0.87);background-color:var(--AppBar-background);color:var(--AppBar-color);background:linear-gradient(45deg, #00ABE4 30%, #00ABE4 90%);box-shadow:0 3px 10px 0 rgba(0,92,191,0.3);z-index:1100;}</style><style data-emotion="css o0syjj">.css-o0syjj{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;box-shadow:var(--Paper-shadow);background-image:var(--Paper-overlay);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:-webkit-sticky;position:sticky;z-index:1100;top:0;left:auto;right:0;--AppBar-background:#00ABE4;--AppBar-color:rgba(0, 0, 0, 0.87);background-color:var(--AppBar-background);color:var(--AppBar-color);background:linear-gradient(45deg, #00ABE4 30%, #00ABE4 90%);box-shadow:0 3px 10px 0 rgba(0,92,191,0.3);z-index:1100;}</style><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation2 MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionSticky css-o0syjj" style="--Paper-shadow:0px 3px 1px -2px rgba(0,0,0,0.2),0px 2px 2px 0px rgba(0,0,0,0.14),0px 1px 5px 0px rgba(0,0,0,0.12)"><style data-emotion="css 1m4126t">.css-1m4126t{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:16px;padding-right:16px;min-height:56px;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;}@media (min-width:600px){.css-1m4126t{padding-left:24px;padding-right:24px;}}@media (min-width:0px){@media (orientation: landscape){.css-1m4126t{min-height:48px;}}}@media (min-width:600px){.css-1m4126t{min-height:64px;}}</style><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-1m4126t"><style data-emotion="css 70qvj9">.css-70qvj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="MuiBox-root css-70qvj9"><style data-emotion="css dwa4tw">.css-dwa4tw{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;width:40px;height:40px;font-family:"Roboto","Helvetica","Arial",sans-serif;font-size:1.25rem;line-height:1;border-radius:50%;overflow:hidden;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:40px;height:40px;margin-right:16px;border:2px solid rgba(255,255,255,0.3);-webkit-transition:-webkit-transform 0.2s;transition:transform 0.2s;}.css-dwa4tw:hover{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);transform:scale(1.1);}</style><div aria-label="BetweenSystems - Where technology meets curiosity" class="MuiAvatar-root MuiAvatar-circular css-dwa4tw"><style data-emotion="css 45do71">.css-45do71{width:100%;height:100%;text-align:center;object-fit:cover;color:transparent;text-indent:10000px;}</style><img alt="BetweenSystems logo" src="/betweensystems/logo.svg" class="MuiAvatar-img css-45do71"/></div><style data-emotion="css 1f5p11z">.css-1f5p11z{z-index:1500;pointer-events:none;pointer-events:auto;pointer-events:none;}</style><style data-emotion="css 1vxh2dt">.css-1vxh2dt{z-index:1500;pointer-events:none;pointer-events:auto;pointer-events:none;}</style><style data-emotion="css 13h7zfx">.css-13h7zfx{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:1.25rem;line-height:1.6;letter-spacing:0.0075em;color:#fff;-webkit-text-decoration:none;text-decoration:none;font-weight:700;letter-spacing:0.5px;}.css-13h7zfx:hover{text-shadow:0 0 8px rgba(255,255,255,0.5);}</style><a class="MuiTypography-root MuiTypography-h6 css-13h7zfx" href="/">BetweenSystems</a></div><style data-emotion="css 1i27l4i">.css-1i27l4i{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;gap:8px;}</style><div class="MuiBox-root css-1i27l4i"><style data-emotion="css 9hfp8i">.css-9hfp8i{font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 16px;border:0;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;padding:6px 8px;color:var(--variant-textColor);background-color:var(--variant-textBg);color:inherit;border-color:currentColor;--variant-containedBg:#e0e0e0;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#fff;border-radius:8px;padding-left:16px;padding-right:16px;padding-top:8px;padding-bottom:8px;-webkit-transition:all 0.2s;transition:all 0.2s;}.css-9hfp8i:hover{-webkit-text-decoration:none;text-decoration:none;}.css-9hfp8i.Mui-disabled{color:rgba(0, 0, 0, 0.26);}@media (hover: hover){.css-9hfp8i:hover{--variant-containedBg:#f5f5f5;--variant-textBg:rgba(0, 0, 0, 0.04);--variant-outlinedBg:rgba(0, 0, 0, 0.04);}}.css-9hfp8i.MuiButton-loading{color:transparent;}.css-9hfp8i:focus-visible{outline:2px solid #00ABE4;outline-offset:2px;}.css-9hfp8i:hover{background-color:rgba(255,255,255,0.2);-webkit-transform:translateY(-1px);-moz-transform:translateY(-1px);-ms-transform:translateY(-1px);transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.2);}</style><style data-emotion="css 108ibhc">.css-108ibhc{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 16px;border:0;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;padding:6px 8px;color:var(--variant-textColor);background-color:var(--variant-textBg);color:inherit;border-color:currentColor;--variant-containedBg:#e0e0e0;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:#fff;border-radius:8px;padding-left:16px;padding-right:16px;padding-top:8px;padding-bottom:8px;-webkit-transition:all 0.2s;transition:all 0.2s;}.css-108ibhc::-moz-focus-inner{border-style:none;}.css-108ibhc.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-108ibhc{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-108ibhc:hover{-webkit-text-decoration:none;text-decoration:none;}.css-108ibhc.Mui-disabled{color:rgba(0, 0, 0, 0.26);}@media (hover: hover){.css-108ibhc:hover{--variant-containedBg:#f5f5f5;--variant-textBg:rgba(0, 0, 0, 0.04);--variant-outlinedBg:rgba(0, 0, 0, 0.04);}}.css-108ibhc.MuiButton-loading{color:transparent;}.css-108ibhc:focus-visible{outline:2px solid #00ABE4;outline-offset:2px;}.css-108ibhc:hover{background-color:rgba(255,255,255,0.2);-webkit-transform:translateY(-1px);-moz-transform:translateY(-1px);-ms-transform:translateY(-1px);transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.2);}</style><a class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit css-108ibhc" tabindex="0" href="/about/"><style data-emotion="css cveorv">.css-cveorv{display:inherit;margin-right:8px;margin-left:-4px;}.css-cveorv>*:nth-of-type(1){font-size:20px;}</style><span class="MuiButton-icon MuiButton-startIcon MuiButton-iconSizeMedium css-cveorv"><style data-emotion="css q7mezt">.css-q7mezt{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;fill:currentColor;font-size:1.5rem;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-q7mezt" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4m0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4"></path></svg></span>About</a><a class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit css-108ibhc" tabindex="0" href="/contact/"><span class="MuiButton-icon MuiButton-startIcon MuiButton-iconSizeMedium css-cveorv"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-q7mezt" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2m0 4-8 5-8-5V6l8 5 8-5z"></path></svg></span>Contact</a></div></div></header><style data-emotion="css ckjs13">.css-ckjs13{z-index:1200;}@media (min-width:0px){.css-ckjs13{display:block;}}@media (min-width:960px){.css-ckjs13{display:none;}}.css-ckjs13 .MuiDrawer-paper{box-sizing:border-box;width:250px;background:linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);}</style><main class="MuiBox-root css-0" role="main" aria-label="Blog post content" id="main-content"><style data-emotion="css mgqg4b">.css-mgqg4b{width:100%;margin-left:auto;box-sizing:border-box;margin-right:auto;padding-left:16px;padding-right:16px;margin-top:32px;}@media (min-width:600px){.css-mgqg4b{padding-left:24px;padding-right:24px;}}@media (min-width:960px){.css-mgqg4b{max-width:960px;}}</style><div class="MuiContainer-root MuiContainer-maxWidthMd css-mgqg4b"><style data-emotion="css 1stw50l">.css-1stw50l{margin-bottom:24px;}</style><style data-emotion="css 1v2kxik">.css-1v2kxik{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;color:rgba(0, 0, 0, 0.6);margin-bottom:24px;}</style><nav class="MuiTypography-root MuiTypography-body1 MuiBreadcrumbs-root css-1v2kxik" aria-label="Breadcrumb navigation"><style data-emotion="css 51eq8m">.css-51eq8m{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding:0;margin:0;list-style:none;}</style><ol class="MuiBreadcrumbs-ol css-51eq8m"><li class="MuiBreadcrumbs-li"><a href="/"><span style="display:flex;align-items:center;color:var(--mui-palette-primary-main);text-decoration:none"><style data-emotion="css q7mezt">.css-q7mezt{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;fill:currentColor;font-size:1.5rem;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-q7mezt" focusable="false" aria-hidden="true" viewBox="0 0 24 24" style="margin-right:4px;font-size:20px"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg>Home</span></a></li><style data-emotion="css 1nd5pgh">.css-1nd5pgh{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;margin-left:8px;margin-right:8px;}</style><li aria-hidden="true" class="MuiBreadcrumbs-separator css-1nd5pgh">âº</li><li class="MuiBreadcrumbs-li"><style data-emotion="css 1cr0rz6">.css-1cr0rz6{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;color:rgba(0, 0, 0, 0.87);}</style><p class="MuiTypography-root MuiTypography-body1 css-1cr0rz6">Fixing Concurrent Queries Within the Same Session in ClickHouse Async Python Apps (Uvicorn + FastAPI)</p></li></ol></nav><style data-emotion="css 1yjvs5a">.css-1yjvs5a{margin-bottom:32px;}</style><header class="MuiBox-root css-1yjvs5a"><style data-emotion="css 1kq3u23">.css-1kq3u23{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:300;font-size:3.75rem;line-height:1.2;letter-spacing:-0.00833em;margin-bottom:16px;word-break:break-word;}@media (min-width:0px){.css-1kq3u23{font-size:1.5rem;}}@media (min-width:600px){.css-1kq3u23{font-size:2rem;}}@media (min-width:960px){.css-1kq3u23{font-size:3.5rem;}}</style><h2 class="MuiTypography-root MuiTypography-h2 css-1kq3u23">Fixing Concurrent Queries Within the Same Session in ClickHouse Async Python Apps (Uvicorn + FastAPI)</h2><style data-emotion="css 1vwg8tb">.css-1vwg8tb{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;gap:16px;margin-bottom:16px;-webkit-box-pack:justify;-webkit-justify-content:space-between;justify-content:space-between;width:100%;max-width:100%;min-width:0;overflow:hidden;}</style><div class="MuiBox-root css-1vwg8tb"><style data-emotion="css 10vyzj9">.css-10vyzj9{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;gap:16px;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;min-width:0;max-width:100%;}</style><div class="MuiBox-root css-10vyzj9"><style data-emotion="css 1e0z5ov">.css-1e0z5ov{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.57;letter-spacing:0.00714em;color:rgba(0, 0, 0, 0.6);}</style><time class="MuiTypography-root MuiTypography-subtitle2 css-1e0z5ov" dateTime="2025-10-16">Published: <!-- -->October 16, 2025</time></div><style data-emotion="css b9s6er">.css-b9s6er{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;gap:8px;margin-left:auto;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;min-width:0;max-width:100%;}</style><div class="MuiBox-root css-b9s6er"><style data-emotion="css 180s6i3">.css-180s6i3{text-align:center;-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;font-size:1.5rem;padding:8px;border-radius:50%;color:rgba(0, 0, 0, 0.54);-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;--IconButton-hoverBg:rgba(0, 0, 0, 0.04);padding:5px;font-size:1.125rem;}.css-180s6i3:hover{background-color:var(--IconButton-hoverBg);}@media (hover: none){.css-180s6i3:hover{background-color:transparent;}}.css-180s6i3.Mui-disabled{background-color:transparent;color:rgba(0, 0, 0, 0.26);}.css-180s6i3.MuiIconButton-loading{color:transparent;}.css-180s6i3:hover svg{color:#00ABE4;}</style><style data-emotion="css 1rfgnle">.css-1rfgnle{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;text-align:center;-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;font-size:1.5rem;padding:8px;border-radius:50%;color:rgba(0, 0, 0, 0.54);-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;--IconButton-hoverBg:rgba(0, 0, 0, 0.04);padding:5px;font-size:1.125rem;}.css-1rfgnle::-moz-focus-inner{border-style:none;}.css-1rfgnle.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-1rfgnle{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-1rfgnle:hover{background-color:var(--IconButton-hoverBg);}@media (hover: none){.css-1rfgnle:hover{background-color:transparent;}}.css-1rfgnle.Mui-disabled{background-color:transparent;color:rgba(0, 0, 0, 0.26);}.css-1rfgnle.MuiIconButton-loading{color:transparent;}.css-1rfgnle:hover svg{color:#00ABE4;}</style><a class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall css-1rfgnle" tabindex="0" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fbetweensystems.com%2Ffixing-concurrent-queries-within-the-same-session-in-clickHouse-async-python-apps&amp;text=Fixing%20Concurrent%20Queries%20Within%20the%20Same%20Session%20in%20ClickHouse%20Async%20Python%20Apps%20(Uvicorn%20%2B%20FastAPI)" target="_blank" rel="noopener noreferrer" aria-label="Share on Twitter"><style data-emotion="css vh810p">.css-vh810p{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;fill:currentColor;font-size:1.25rem;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-vh810p" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"></path></svg></a><a class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall css-1rfgnle" tabindex="0" href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fbetweensystems.com%2Ffixing-concurrent-queries-within-the-same-session-in-clickHouse-async-python-apps" target="_blank" rel="noopener noreferrer" aria-label="Share on Facebook"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-vh810p" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2m13 2h-2.5A3.5 3.5 0 0 0 12 8.5V11h-2v3h2v7h3v-7h3v-3h-3V9a1 1 0 0 1 1-1h2V5z"></path></svg></a><a class="MuiButtonBase-root MuiIconButton-root MuiIconButton-sizeSmall css-1rfgnle" tabindex="0" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fbetweensystems.com%2Ffixing-concurrent-queries-within-the-same-session-in-clickHouse-async-python-apps&amp;title=Fixing%20Concurrent%20Queries%20Within%20the%20Same%20Session%20in%20ClickHouse%20Async%20Python%20Apps%20(Uvicorn%20%2B%20FastAPI)" target="_blank" rel="noopener noreferrer" aria-label="Share on LinkedIn"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-vh810p" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"></path></svg></a></div></div><style data-emotion="css i3pbo">.css-i3pbo{margin-bottom:24px;}</style><div class="MuiBox-root css-i3pbo" role="navigation" aria-label="Article tags"><style data-emotion="css 19rl8v">.css-19rl8v{max-width:100%;font-family:"Roboto","Helvetica","Arial",sans-serif;font-size:0.8125rem;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;height:32px;line-height:1.5;color:rgba(0, 0, 0, 0.87);background-color:rgba(0, 0, 0, 0.08);border-radius:16px;white-space:nowrap;-webkit-transition:background-color 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;cursor:unset;outline:0;-webkit-text-decoration:none;text-decoration:none;border:0;padding:0;vertical-align:middle;box-sizing:border-box;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;cursor:pointer;cursor:pointer;-webkit-transition:background 0.2s;transition:background 0.2s;margin-right:8px;margin-bottom:8px;color:#fff;background-color:#00ABE4;-webkit-transition:background 0.2s,color 0.2s,font-weight 0.2s;transition:background 0.2s,color 0.2s,font-weight 0.2s;}.css-19rl8v.Mui-disabled{opacity:0.38;pointer-events:none;}.css-19rl8v .MuiChip-avatar{margin-left:5px;margin-right:-6px;width:24px;height:24px;color:#616161;font-size:0.75rem;}.css-19rl8v .MuiChip-avatarColorPrimary{color:rgba(0, 0, 0, 0.87);background-color:rgb(0, 119, 159);}.css-19rl8v .MuiChip-avatarColorSecondary{color:#fff;background-color:rgb(150, 28, 28);}.css-19rl8v .MuiChip-avatarSmall{margin-left:4px;margin-right:-4px;width:18px;height:18px;font-size:0.625rem;}.css-19rl8v .MuiChip-icon{margin-left:5px;margin-right:-6px;}.css-19rl8v .MuiChip-deleteIcon{-webkit-tap-highlight-color:transparent;color:rgba(0, 0, 0, 0.26);font-size:22px;cursor:pointer;margin:0 5px 0 -6px;}.css-19rl8v .MuiChip-deleteIcon:hover{color:rgba(0, 0, 0, 0.4);}.css-19rl8v .MuiChip-icon{color:#616161;}.css-19rl8v:hover{background-color:rgba(0, 0, 0, 0.12);}.css-19rl8v.Mui-focusVisible{background-color:rgba(0, 0, 0, 0.2);}.css-19rl8v:active{box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);}.css-19rl8v:hover{background-color:#0FFCBE;color:#00ABE4;}.css-19rl8v .MuiChip-icon{color:#fff;-webkit-transition:color 0.2s,font-weight 0.2s;transition:color 0.2s,font-weight 0.2s;}.css-19rl8v:hover{background-color:#0FFCBE;color:#000;font-weight:700;}.css-19rl8v:hover .MuiChip-icon{color:#000;}</style><style data-emotion="css 6iktoe">.css-6iktoe{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;max-width:100%;font-family:"Roboto","Helvetica","Arial",sans-serif;font-size:0.8125rem;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;height:32px;line-height:1.5;color:rgba(0, 0, 0, 0.87);background-color:rgba(0, 0, 0, 0.08);border-radius:16px;white-space:nowrap;-webkit-transition:background-color 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;cursor:unset;outline:0;-webkit-text-decoration:none;text-decoration:none;border:0;padding:0;vertical-align:middle;box-sizing:border-box;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;-webkit-tap-highlight-color:transparent;cursor:pointer;cursor:pointer;-webkit-transition:background 0.2s;transition:background 0.2s;margin-right:8px;margin-bottom:8px;color:#fff;background-color:#00ABE4;-webkit-transition:background 0.2s,color 0.2s,font-weight 0.2s;transition:background 0.2s,color 0.2s,font-weight 0.2s;}.css-6iktoe::-moz-focus-inner{border-style:none;}.css-6iktoe.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-6iktoe{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-6iktoe.Mui-disabled{opacity:0.38;pointer-events:none;}.css-6iktoe .MuiChip-avatar{margin-left:5px;margin-right:-6px;width:24px;height:24px;color:#616161;font-size:0.75rem;}.css-6iktoe .MuiChip-avatarColorPrimary{color:rgba(0, 0, 0, 0.87);background-color:rgb(0, 119, 159);}.css-6iktoe .MuiChip-avatarColorSecondary{color:#fff;background-color:rgb(150, 28, 28);}.css-6iktoe .MuiChip-avatarSmall{margin-left:4px;margin-right:-4px;width:18px;height:18px;font-size:0.625rem;}.css-6iktoe .MuiChip-icon{margin-left:5px;margin-right:-6px;}.css-6iktoe .MuiChip-deleteIcon{-webkit-tap-highlight-color:transparent;color:rgba(0, 0, 0, 0.26);font-size:22px;cursor:pointer;margin:0 5px 0 -6px;}.css-6iktoe .MuiChip-deleteIcon:hover{color:rgba(0, 0, 0, 0.4);}.css-6iktoe .MuiChip-icon{color:#616161;}.css-6iktoe:hover{background-color:rgba(0, 0, 0, 0.12);}.css-6iktoe.Mui-focusVisible{background-color:rgba(0, 0, 0, 0.2);}.css-6iktoe:active{box-shadow:0px 2px 1px -1px rgba(0,0,0,0.2),0px 1px 1px 0px rgba(0,0,0,0.14),0px 1px 3px 0px rgba(0,0,0,0.12);}.css-6iktoe:hover{background-color:#0FFCBE;color:#00ABE4;}.css-6iktoe .MuiChip-icon{color:#fff;-webkit-transition:color 0.2s,font-weight 0.2s;transition:color 0.2s,font-weight 0.2s;}.css-6iktoe:hover{background-color:#0FFCBE;color:#000;font-weight:700;}.css-6iktoe:hover .MuiChip-icon{color:#000;}</style><a class="MuiButtonBase-root MuiChip-root MuiChip-filled MuiChip-sizeBig MuiChip-colorDefault MuiChip-clickable MuiChip-clickableColorDefault MuiChip-filledDefault css-6iktoe" tabindex="0" aria-label="View all posts tagged with Python" href="/tag/Python/"><style data-emotion="css hs4z5d">.css-hs4z5d{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;fill:currentColor;font-size:1.25rem;color:#fff;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall MuiChip-icon MuiChip-iconBig MuiChip-iconColorDefault css-hs4z5d" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"></path></svg><style data-emotion="css s01idy">.css-s01idy{overflow:hidden;text-overflow:ellipsis;padding-left:12px;padding-right:12px;white-space:nowrap;}</style><span class="MuiChip-label MuiChip-labelBig css-s01idy">Python</span></a><a class="MuiButtonBase-root MuiChip-root MuiChip-filled MuiChip-sizeBig MuiChip-colorDefault MuiChip-clickable MuiChip-clickableColorDefault MuiChip-filledDefault css-6iktoe" tabindex="0" aria-label="View all posts tagged with ClickHouse" href="/tag/ClickHouse/"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall MuiChip-icon MuiChip-iconBig MuiChip-iconColorDefault css-hs4z5d" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"></path></svg><span class="MuiChip-label MuiChip-labelBig css-s01idy">ClickHouse</span></a><a class="MuiButtonBase-root MuiChip-root MuiChip-filled MuiChip-sizeBig MuiChip-colorDefault MuiChip-clickable MuiChip-clickableColorDefault MuiChip-filledDefault css-6iktoe" tabindex="0" aria-label="View all posts tagged with Uvicorn" href="/tag/Uvicorn/"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall MuiChip-icon MuiChip-iconBig MuiChip-iconColorDefault css-hs4z5d" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"></path></svg><span class="MuiChip-label MuiChip-labelBig css-s01idy">Uvicorn</span></a><a class="MuiButtonBase-root MuiChip-root MuiChip-filled MuiChip-sizeBig MuiChip-colorDefault MuiChip-clickable MuiChip-clickableColorDefault MuiChip-filledDefault css-6iktoe" tabindex="0" aria-label="View all posts tagged with Concurrency" href="/tag/Concurrency/"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall MuiChip-icon MuiChip-iconBig MuiChip-iconColorDefault css-hs4z5d" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"></path></svg><span class="MuiChip-label MuiChip-labelBig css-s01idy">Concurrency</span></a><a class="MuiButtonBase-root MuiChip-root MuiChip-filled MuiChip-sizeBig MuiChip-colorDefault MuiChip-clickable MuiChip-clickableColorDefault MuiChip-filledDefault css-6iktoe" tabindex="0" aria-label="View all posts tagged with Architecture" href="/tag/Architecture/"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall MuiChip-icon MuiChip-iconBig MuiChip-iconColorDefault css-hs4z5d" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"></path></svg><span class="MuiChip-label MuiChip-labelBig css-s01idy">Architecture</span></a><a class="MuiButtonBase-root MuiChip-root MuiChip-filled MuiChip-sizeBig MuiChip-colorDefault MuiChip-clickable MuiChip-clickableColorDefault MuiChip-filledDefault css-6iktoe" tabindex="0" aria-label="View all posts tagged with DevOps" href="/tag/DevOps/"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall MuiChip-icon MuiChip-iconBig MuiChip-iconColorDefault css-hs4z5d" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M20 10V8h-4V4h-2v4h-4V4H8v4H4v2h4v4H4v2h4v4h2v-4h4v4h2v-4h4v-2h-4v-4zm-6 4h-4v-4h4z"></path></svg><span class="MuiChip-label MuiChip-labelBig css-s01idy">DevOps</span></a></div></header><figure style="margin:24px 0;text-align:center;max-width:100%;overflow:auto"><img alt="Cover image for &quot;Fixing Concurrent Queries Within the Same Session in ClickHouse Async Python Apps (Uvicorn + FastAPI)&quot;" width="1200" height="630" decoding="async" data-nimg="1" style="color:transparent;max-width:100%;height:auto;border-radius:8px;box-shadow:0 2px 16px #00336622;display:block;min-width:0" src="/images/ch1/cover.jpg"/></figure><style data-emotion="css 1gujd01">.css-1gujd01{margin-top:24px;margin-bottom:32px;width:100%;max-width:100%;overflow-x:auto;min-width:0;}</style><article class="MuiBox-root css-1gujd01" aria-label="Article content"><p>Connecting to a database from Python seems simple enough - you create a client, send queries, and handle results. But when we scaled that to thousands of concurrent requests under an async web server, things got a bit more interesting.</p>
<p>This post walks through how we hit a classic concurrency issue in our ClickHouse integration - how it appeared, what caused it, the quick fix we applied, and finally how we designed a long-term scalable solution using an async connection pool.</p>
<h2>The Setup</h2>
<p>Our backend service is a data ingestion API that pushes concurrent large JSON payloads into ClickHouse. It runs on top of <a href="https://uvicorn.dev/" target="_blank" rel="noopener noreferrer"><strong>Uvicorn</strong></a>, an ASGI web server that handles requests asynchronously.</p>
<p>We used the official <a href="https://github.com/ClickHouse/clickhouse-connect" target="_blank" rel="noopener noreferrer">clickhouse-connect</a> library to communicate with the database. In the beginning, the design looked clean and simple:</p>
<pre><div style="background:#ffffff;color:hsl(230, 8%, 24%);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:16px 0;overflow:auto;border-radius:8px;font-size:1rem"><code class="language-python" style="white-space:pre;background:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(230, 4%, 64%);font-style:italic"># Simplified version of the initial design</span><span>
</span>
<span></span><span class="token" style="color:hsl(301, 63%, 40%)">class</span><span> </span><span class="token" style="color:hsl(35, 99%, 36%)">CB</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(301, 63%, 40%)">def</span><span> </span><span class="token" style="color:hsl(221, 87%, 60%)">__init__</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>self</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>        self</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>client </span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span> AsyncClient</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>
</span><span>            host</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span class="token" style="color:hsl(119, 34%, 47%)">&quot;clickhouse_host&quot;</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span>
</span><span>            port</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span class="token" style="color:hsl(35, 99%, 36%)">8123</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span>
</span><span>            database</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span class="token" style="color:hsl(119, 34%, 47%)">&quot;DB_NAME&quot;</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span>
</span><span>            username</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span class="token" style="color:hsl(119, 34%, 47%)">&quot;default&quot;</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span>
</span><span>            password</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span class="token" style="color:hsl(119, 34%, 47%)">&quot;default&quot;</span><span>
</span><span>        </span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(301, 63%, 40%)">async</span><span> </span><span class="token" style="color:hsl(301, 63%, 40%)">def</span><span> </span><span class="token" style="color:hsl(221, 87%, 60%)">post_raw</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>self</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span> payload</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>        </span><span class="token" style="color:hsl(301, 63%, 40%)">await</span><span> self</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>client</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>insert</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>table</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span class="token" style="color:hsl(119, 34%, 47%)">&quot;m_data&quot;</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span> data</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span>payload</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span></code></div></pre>
<p>We created <strong>a single AsyncClient instance</strong> when the backend started - a singleton pattern. Every request reused this same client to perform queries, inserts and health checks.</p>
<p>We leveraged <a href="https://clickhouse.com/docs/optimize/asynchronous-inserts" target="_blank" rel="noopener noreferrer">ClickHouse&#x27;s server-side asynchronous insert</a> feature by configuring the insertion settings to use <em><strong>async_insert=1</strong></em>. This setting is key for high-throughput ingestion, as it tells the <a href="https://clickhouse.com/blog/asynchronous-data-inserts-in-clickhouse" target="_blank" rel="noopener noreferrer">ClickHouse server to buffer and batch data internally</a>. However, as we soon discovered, server-side data handling being asynchronous does not guarantee client-side session safety.</p>
<h2>The Problem Appears</h2>
<p>Everything was smooth in development and staging environments. It looked fine - until we hit production and started ingesting thousands of rows per minute, the logs exploded with the following message:</p>
<blockquote>
<p><em><strong>Attempt to execute concurrent queries within the same session. Please use a separate client instance per thread/process.</strong></em></p>
</blockquote>
<p>Thirty percent of the inserts began failing randomly under load. Some succeeded, others didn&#x27;t. It wasn&#x27;t deterministic - but it was bad.</p>
<h2>The Role of Uvicorn and Async Concurrency</h2>
<p>Our API application runs on <strong>Uvicorn</strong> web server, which means requests are handled <em>asynchronously</em> on a single <a href="https://uvicorn.dev/concepts/event-loop/" target="_blank" rel="noopener noreferrer">event loop</a> by the <a href="https://github.com/MagicStack/uvloop" target="_blank" rel="noopener noreferrer"><em>uvloop</em> library</a>.</p>
<p>In async Python, multiple <a href="https://docs.python.org/3/library/asyncio-task.html" target="_blank" rel="noopener noreferrer">coroutines</a> (i.e., concurrent requests) share the same event loop and can all run at once when waiting on I/O. So even though we weren&#x27;t using multiple OS threads (no parallelism), we achieved high concurrency within the same single-threaded process by efficiently switching between waiting requests.</p>
<p>Here&#x27;s what was happening under the hood:</p>
<p><img alt="img" loading="lazy" width="800" height="600" decoding="async" data-nimg="1" style="color:transparent;max-width:100%;height:auto;border-radius:8px;box-shadow:0 2px 16px #00336622;margin:16px 0;min-width:0" src="/images/ch1/image_1.jpg"/></p>
<p>Because all requests used the <strong>same Clickhouse AsyncClient instance</strong>, multiple coroutines tried to send different queries over the same underlying TCP session - at the same time. This scenario is a classic example of shared mutable state in an asynchronous environment. Multiple requests raced to use the same underlying socket before the previous query had finished, violating the database client&#x27;s contract.</p>
<p>ClickHouse rightfully rejected this pattern. Its client session protocol doesn&#x27;t support multiple concurrent queries per connection. Each query must complete before another begins on the same connection.</p>
<p>It&#x27;s important to distinguish between ClickHouse&#x27;s server-side asynchronous insert feature (async_insert=1) and our client-side asynchronous concurrency (Uvicorn/coroutine model). The server-side feature efficiently buffers the data. However, the client driver still requires a non-conflicting network session to send the insert request and receive the response (even if that response is a quick acknowledgement). Our problem was that multiple coroutines were attempting to initiate their separate insert operations over the single shared client session at the exact same moment, which the client/session protocol disallowed. The fix was necessary to resolve the session-level concurrency issue, not the server&#x27;s data-buffering mechanism.</p>
<p>That&#x27;s why the error message said:</p>
<blockquote>
<p><em><strong>Please use a separate client instance per thread/process.</strong></em></p>
</blockquote>
<p>Even though we weren&#x27;t using multiple threads, we had the same effect: concurrent use of a shared connection.</p>
<h2>Quick Fix: One Client per Request</h2>
<p>When production fire alarms are ringing, elegance comes second.</p>
<p>As a <strong>quick fix</strong>, we changed our approach to create a <strong>new ClickHouse client per request</strong>.</p>
<pre><div style="background:#ffffff;color:hsl(230, 8%, 24%);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:16px 0;overflow:auto;border-radius:8px;font-size:1rem"><code class="language-python" style="white-space:pre;background:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(301, 63%, 40%)">async</span><span> </span><span class="token" style="color:hsl(301, 63%, 40%)">def</span><span> </span><span class="token" style="color:hsl(221, 87%, 60%)">post_data</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>self</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span> payload</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>    </span><span class="token" style="color:hsl(301, 63%, 40%)">async</span><span> </span><span class="token" style="color:hsl(301, 63%, 40%)">with</span><span> AsyncClient</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>client</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span>get_client</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span> </span><span class="token" style="color:hsl(301, 63%, 40%)">as</span><span> client</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>        </span><span class="token" style="color:hsl(301, 63%, 40%)">await</span><span> client</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>insert</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span></code></div></pre>
<p>That immediately solved the concurrency issue. Each request had its own isolated client - and therefore its own TCP session - avoiding shared-state problems completely.</p>
<p>But this (and probably most) quick solution came at a cost.</p>
<p>Creating and closing a ClickHouse client for every single request is expensive. At large ingestion volumes, it increases connection setup overhead, authentication latency, and CPU churn on both the client and server sides.</p>
<p>We needed something more efficient.</p>
<h2>The Final Fix: Connection Pooling</h2>
<p>Once stability returned, we revisited the design.</p>
<p>Instead of one global client or one-per-request, we moved to a <strong>connection pool</strong> - maintaining a fixed number of ready-to-use ClickHouse clients and reusing them efficiently.</p>
<p><img alt="img" loading="lazy" width="800" height="600" decoding="async" data-nimg="1" style="color:transparent;max-width:100%;height:auto;border-radius:8px;box-shadow:0 2px 16px #00336622;margin:16px 0;min-width:0" src="/images/ch1/image_2.jpg"/></p>
<h3>New approach</h3>
<pre><div style="background:#ffffff;color:hsl(230, 8%, 24%);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:16px 0;overflow:auto;border-radius:8px;font-size:1rem"><code class="language-python" style="white-space:pre;background:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:hsl(301, 63%, 40%)">class</span><span> </span><span class="token" style="color:hsl(35, 99%, 36%)">PooledClient</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>    </span><span class="token triple-quoted-string" style="color:hsl(119, 34%, 47%)">&quot;&quot;&quot;Helper Context Manager Class&quot;&quot;&quot;</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(301, 63%, 40%)">def</span><span> </span><span class="token" style="color:hsl(221, 87%, 60%)">__init__</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>self</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span> pool</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span> client</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>        self</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>_pool </span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span> pool
</span><span>        self</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>client </span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span> client
</span>
<span>    </span><span class="token" style="color:hsl(301, 63%, 40%)">async</span><span> </span><span class="token" style="color:hsl(301, 63%, 40%)">def</span><span> </span><span class="token" style="color:hsl(221, 87%, 60%)">__aenter__</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>self</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>        </span><span class="token triple-quoted-string" style="color:hsl(119, 34%, 47%)">&quot;&quot;&quot;Called when &#x27;async with&#x27; starts&quot;&quot;&quot;</span><span>
</span><span>        </span><span class="token" style="color:hsl(301, 63%, 40%)">return</span><span> self</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>client
</span>
<span>    </span><span class="token" style="color:hsl(301, 63%, 40%)">async</span><span> </span><span class="token" style="color:hsl(301, 63%, 40%)">def</span><span> </span><span class="token" style="color:hsl(221, 87%, 60%)">__aexit__</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>self</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span> exc_type</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span> exc_val</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span> exc_tb</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>        </span><span class="token triple-quoted-string" style="color:hsl(119, 34%, 47%)">&quot;&quot;&quot;
</span><span class="token triple-quoted-string" style="color:hsl(119, 34%, 47%)">        Called when &#x27;async with&#x27; block ends (even on error).
</span><span class="token triple-quoted-string" style="color:hsl(119, 34%, 47%)">        For simplicity, we just return the client to the pool.
</span><span class="token triple-quoted-string" style="color:hsl(119, 34%, 47%)">        (You could add logic here to replace broken clients.)
</span><span class="token triple-quoted-string" style="color:hsl(119, 34%, 47%)">        &quot;&quot;&quot;</span><span>
</span><span>        </span><span class="token" style="color:hsl(301, 63%, 40%)">if</span><span> </span><span class="token" style="color:hsl(301, 63%, 40%)">not</span><span> </span><span class="token" style="color:hsl(119, 34%, 47%)">getattr</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>self</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>client</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span> </span><span class="token" style="color:hsl(119, 34%, 47%)">&quot;is_closed&quot;</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span> </span><span class="token" style="color:hsl(35, 99%, 36%)">False</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>            </span><span class="token" style="color:hsl(301, 63%, 40%)">await</span><span> self</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>_pool</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>put</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>self</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>client</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span>
</span><span>        </span><span class="token" style="color:hsl(301, 63%, 40%)">return</span><span> </span><span class="token" style="color:hsl(35, 99%, 36%)">False</span><span>
</span>
<!-- -->
<span></span><span class="token" style="color:hsl(301, 63%, 40%)">class</span><span> </span><span class="token" style="color:hsl(35, 99%, 36%)">ClickhousePool</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>    </span><span class="token triple-quoted-string" style="color:hsl(119, 34%, 47%)">&quot;&quot;&quot;Main Connection Pool Class&quot;&quot;&quot;</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(301, 63%, 40%)">def</span><span> </span><span class="token" style="color:hsl(221, 87%, 60%)">__init__</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>self</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>        self</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>_pool </span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span> asyncio</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>Queue</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>maxsize</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span>SIZE</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span>
</span><span>        </span><span class="token" style="color:hsl(301, 63%, 40%)">for</span><span> _ </span><span class="token" style="color:hsl(301, 63%, 40%)">in</span><span> </span><span class="token" style="color:hsl(119, 34%, 47%)">range</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>SIZE</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>            client </span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span> AsyncClient</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>client</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span>get_client</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span>
</span><span>            self</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>_pool</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>put_nowait</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>client</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(301, 63%, 40%)">async</span><span> </span><span class="token" style="color:hsl(301, 63%, 40%)">def</span><span> </span><span class="token" style="color:hsl(221, 87%, 60%)">get_client</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>self</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>        </span><span class="token triple-quoted-string" style="color:hsl(119, 34%, 47%)">&quot;&quot;&quot;Returns a context manager object that handles the client lifecycle&quot;&quot;&quot;</span><span>
</span><span>        </span><span class="token" style="color:hsl(301, 63%, 40%)">return</span><span> PooledClient</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>self</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>_pool</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span> </span><span class="token" style="color:hsl(301, 63%, 40%)">await</span><span> self</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>_pool</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>get</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span>
</span>
<span>    </span><span class="token" style="color:hsl(301, 63%, 40%)">async</span><span> </span><span class="token" style="color:hsl(301, 63%, 40%)">def</span><span> </span><span class="token" style="color:hsl(221, 87%, 60%)">post_data</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>self</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span> payload</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>        </span><span class="token triple-quoted-string" style="color:hsl(119, 34%, 47%)">&quot;&quot;&quot;The Clean Consumption in the API&quot;&quot;&quot;</span><span>
</span><span>        rows </span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span> </span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>  </span><span class="token" style="color:hsl(230, 4%, 64%);font-style:italic"># transformations of payload</span><span>
</span><span>        table_name </span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span> </span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>
</span><span>        columns </span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span> </span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>
</span>
<span>        </span><span class="token" style="color:hsl(301, 63%, 40%)">async</span><span> </span><span class="token" style="color:hsl(301, 63%, 40%)">with</span><span> self</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>get_client</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span> </span><span class="token" style="color:hsl(301, 63%, 40%)">as</span><span> client</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span>
</span><span>            </span><span class="token" style="color:hsl(301, 63%, 40%)">await</span><span> client</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>insert</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>
</span><span>                table</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span>table_name</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span>
</span><span>                data</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span>rows</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span>
</span><span>                column_names</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span>columns</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span>
</span><span>                settings</span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span class="token" style="color:hsl(230, 8%, 24%)">{</span><span>
</span><span>                    </span><span class="token" style="color:hsl(119, 34%, 47%)">&#x27;async_insert&#x27;</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span> </span><span class="token" style="color:hsl(35, 99%, 36%)">1</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span>
</span><span>                    </span><span class="token" style="color:hsl(119, 34%, 47%)">&#x27;wait_for_async_insert&#x27;</span><span class="token" style="color:hsl(230, 8%, 24%)">:</span><span> </span><span class="token" style="color:hsl(35, 99%, 36%)">0</span><span class="token" style="color:hsl(230, 8%, 24%)">,</span><span>
</span><span>                    </span><span class="token" style="color:hsl(230, 4%, 64%);font-style:italic"># ... other settings</span><span>
</span><span>                </span><span class="token" style="color:hsl(230, 8%, 24%)">}</span><span>
</span><span>            </span><span class="token" style="color:hsl(230, 8%, 24%)">)</span></code></div></pre>
<p>Once the connection pool is in place, usage of async API is straightforward:</p>
<pre><div style="background:#ffffff;color:hsl(230, 8%, 24%);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:16px 0;overflow:auto;border-radius:8px;font-size:1rem"><code class="language-python" style="white-space:pre;background:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>cp </span><span class="token" style="color:hsl(221, 87%, 60%)">=</span><span> ClickhousePool</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span><span>
</span><span></span><span class="token" style="color:hsl(301, 63%, 40%)">await</span><span> cp</span><span class="token" style="color:hsl(230, 8%, 24%)">.</span><span>post_data</span><span class="token" style="color:hsl(230, 8%, 24%)">(</span><span>payload</span><span class="token" style="color:hsl(230, 8%, 24%)">)</span></code></div></pre>
<p>With the pooled design we make sure that, (1) each of the requests borrow a client from the pool, (2) they use it to execute a query or insert, (3) the client is released back into the pool afterward, (4) if a client breaks (due to a network or protocol error), it&#x27;s replaced with a new one.</p>
<p>This hybrid approach provides safety by not sharing clients across concurrent requests, performance by avoiding recreate clients repeatedly, scalability by easily tune pool size to match workload.</p>
<pre><div style="background:#ffffff;color:hsl(230, 8%, 24%);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:16px 0;overflow:auto;border-radius:8px;font-size:1rem"><code class="language-txt" style="white-space:pre;background:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%);font-family:&quot;Fira Code&quot;, &quot;Fira Mono&quot;, Menlo, Consolas, &quot;DejaVu Sans Mono&quot;, monospace;direction:ltr;text-align:left;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>Singleton        -&gt;  One global AsyncClient
</span>Per-request      -&gt;  New client per request
<!-- -->Connection pool  -&gt;  Limited shared pool, reused safely</code></div></pre>
<h2>Validation and Results</h2>
<p>Once deployed, the difference was clear.</p>
<p>We validated the new behavior in three ways. Error messages related to <em><strong>concurrent queries within the same session</strong></em> disappeared completely. Connection metrics stabilized - fewer reconnections, more consistent query latencies. The ClickHouse row count graphs started growing linearly again - confirming ingestion pipelines were back to full capacity.</p>
<h2>Lessons Learned</h2>
<p>One of the key takeaways from this experience was realizing that asynchronous code isn&#x27;t automatically thread-safe or concurrency-safe. Using async functions doesn&#x27;t guarantee that shared resources can be accessed safely by multiple coroutines. In our case, reusing a single AsyncClient across concurrent requests seemed fine at first, but when multiple coroutines tried to use it simultaneously, it led to unexpected failures. The event loop can rapidly switch between these coroutines, and if the underlying resource isn&#x27;t designed for concurrent access, it will eventually break - exactly as we saw with the ClickHouse client.</p>
<p>We also learned that Uvicorn&#x27;s speed comes from concurrency, not parallelism. It multiplexes many requests on a single event loop in one process. That means even though the server feels lightweight and fast, all those requests are sharing the same runtime environment. Any global object - such as a database connection, HTTP session, or cache client - must be carefully managed to ensure it&#x27;s concurrency-safe. The illusion of simplicity in async code can be deceptive; behind the scenes, coroutines are continuously yielding and resuming, which magnifies issues caused by shared mutable state.</p>
<p>When production problems strike, it&#x27;s often tempting to apply quick fixes to restore stability. We did the same by creating one client per request - a brute-force but effective short-term solution. It isolated each operation and immediately eliminated concurrency conflicts. However, that approach didn&#x27;t scale well. Each new client meant an additional connection handshake, authentication cycle, and network setup overhead. It worked to stop the bleeding, but it wasn&#x27;t efficient enough for a high-throughput ingestion system. A connection pool, on the other hand, gave us the right balance - isolation without excessive overhead.</p>
<p>Finally, this journey reinforced that observability is critical. Without clear logs, metrics, and dashboards, it would have been nearly impossible to pinpoint the root cause or verify the effectiveness of our fix. Our Grafana dashboards, error logs, and ClickHouse ingestion metrics made it clear when the issue appeared, how severe it was, and how things stabilized after deploying the pooled solution. Good observability turned what could have been a long debugging marathon into a structured diagnosis and validation process.</p>
<h2>Closing Thoughts</h2>
<p>This issue was a great reminder that even high-level async code hides some deep concurrency challenges underneath.</p>
<p>The evolution - from a single shared client, to per-request isolation, to an efficient async connection pool - illustrates how understanding the <strong>runtime model</strong> (Uvicorn + async I/O) is just as important as writing correct business logic.</p></article><style data-emotion="css o3iir5">.css-o3iir5{position:fixed;top:0;left:0;right:0;height:4px;z-index:1000;}</style><div class="MuiBox-root css-o3iir5"><style data-emotion="css aad69k">.css-aad69k{width:0%;height:100%;background:linear-gradient(90deg, #00ABE4 0%, #0070f3 100%);-webkit-transition:width 0.1s ease-out;transition:width 0.1s ease-out;}</style><div class="MuiBox-root css-aad69k" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-label="Reading progress"></div></div></div></main><style data-emotion="css 1qcvbhb">.css-1qcvbhb{margin-top:64px;padding-top:32px;padding-bottom:32px;background-color:#f5f5f5;border-top:1px solid;border-color:rgba(0, 0, 0, 0.12);text-align:center;}</style><footer class="MuiBox-root css-1qcvbhb"><style data-emotion="css 1r6u0z4">.css-1r6u0z4{width:100%;margin-left:auto;box-sizing:border-box;margin-right:auto;padding-left:16px;padding-right:16px;}@media (min-width:600px){.css-1r6u0z4{padding-left:24px;padding-right:24px;}}@media (min-width:1280px){.css-1r6u0z4{max-width:1280px;}}</style><div class="MuiContainer-root MuiContainer-maxWidthLg css-1r6u0z4"><style data-emotion="css xi606m">.css-xi606m{text-align:center;}</style><div class="MuiBox-root css-xi606m"><style data-emotion="css 1h4tfvt">.css-1h4tfvt{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:1.25rem;line-height:1.6;letter-spacing:0.0075em;margin-bottom:0.35em;color:#00ABE4;font-weight:700;margin-bottom:8px;}</style><h6 class="MuiTypography-root MuiTypography-h6 MuiTypography-gutterBottom css-1h4tfvt">BetweenSystems</h6><style data-emotion="css 1h8vu2n">.css-1h8vu2n{margin:0;font-size:0.875rem;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;line-height:1.43;letter-spacing:0.01071em;color:rgba(0, 0, 0, 0.6);margin-bottom:24px;max-width:500px;margin-left:auto;margin-right:auto;line-height:1.6;}@media (max-width:600px){.css-1h8vu2n{font-size:0.9rem;}}</style><p class="MuiTypography-root MuiTypography-body2 css-1h8vu2n">Exploring the art and engineering of modern technology â from systems and software to data, people, and the ideas that connect them.</p><style data-emotion="css i3pbo">.css-i3pbo{margin-bottom:24px;}</style><div class="MuiBox-root css-i3pbo"><style data-emotion="css 1wfr0ij">.css-1wfr0ij{text-align:center;-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;font-size:1.5rem;padding:8px;border-radius:50%;color:rgba(0, 0, 0, 0.54);-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;--IconButton-hoverBg:rgba(0, 0, 0, 0.04);color:#00ABE4;--IconButton-hoverBg:rgba(0, 171, 228, 0.04);margin-left:8px;margin-right:8px;}.css-1wfr0ij:hover{background-color:var(--IconButton-hoverBg);}@media (hover: none){.css-1wfr0ij:hover{background-color:transparent;}}.css-1wfr0ij.Mui-disabled{background-color:transparent;color:rgba(0, 0, 0, 0.26);}.css-1wfr0ij.MuiIconButton-loading{color:transparent;}.css-1wfr0ij:hover{background-color:primary.lighter;-webkit-transform:translateY(-2px);-moz-transform:translateY(-2px);-ms-transform:translateY(-2px);transform:translateY(-2px);}</style><style data-emotion="css 15g39pa">.css-15g39pa{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;text-align:center;-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;font-size:1.5rem;padding:8px;border-radius:50%;color:rgba(0, 0, 0, 0.54);-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;--IconButton-hoverBg:rgba(0, 0, 0, 0.04);color:#00ABE4;--IconButton-hoverBg:rgba(0, 171, 228, 0.04);margin-left:8px;margin-right:8px;}.css-15g39pa::-moz-focus-inner{border-style:none;}.css-15g39pa.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-15g39pa{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-15g39pa:hover{background-color:var(--IconButton-hoverBg);}@media (hover: none){.css-15g39pa:hover{background-color:transparent;}}.css-15g39pa.Mui-disabled{background-color:transparent;color:rgba(0, 0, 0, 0.26);}.css-15g39pa.MuiIconButton-loading{color:transparent;}.css-15g39pa:hover{background-color:primary.lighter;-webkit-transform:translateY(-2px);-moz-transform:translateY(-2px);-ms-transform:translateY(-2px);transform:translateY(-2px);}</style><a class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorPrimary MuiIconButton-sizeMedium css-15g39pa" tabindex="0" href="/contact" aria-label="Contact"><style data-emotion="css q7mezt">.css-q7mezt{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;fill:currentColor;font-size:1.5rem;}</style><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-q7mezt" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2m0 4-8 5-8-5V6l8 5 8-5z"></path></svg></a><style data-emotion="css 1f5p11z">.css-1f5p11z{z-index:1500;pointer-events:none;pointer-events:auto;pointer-events:none;}</style><style data-emotion="css 1vxh2dt">.css-1vxh2dt{z-index:1500;pointer-events:none;pointer-events:auto;pointer-events:none;}</style><a class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorPrimary MuiIconButton-sizeMedium css-15g39pa" tabindex="0" href="https://www.x.com/hasan_mehdi" target="_blank" rel="noopener" aria-label="X (formerly Twitter)"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-q7mezt" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></svg></a><a class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorPrimary MuiIconButton-sizeMedium css-15g39pa" tabindex="0" href="https://www.linkedin.com/in/md-mehdi-hasan/" target="_blank" rel="noopener" aria-label="LinkedIn"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-q7mezt" focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M19 3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14m-.5 15.5v-5.3a3.26 3.26 0 0 0-3.26-3.26c-.85 0-1.84.52-2.32 1.3v-1.11h-2.79v8.37h2.79v-4.93c0-.77.62-1.4 1.39-1.4a1.4 1.4 0 0 1 1.4 1.4v4.93h2.79M6.88 8.56a1.68 1.68 0 0 0 1.68-1.68c0-.93-.75-1.69-1.68-1.69a1.69 1.69 0 0 0-1.69 1.69c0 .93.76 1.68 1.69 1.68m1.39 9.94v-8.37H5.5v8.37h2.77z"></path></svg></a></div><style data-emotion="css 1pjwakg">.css-1pjwakg{margin:0;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;border-width:0;border-style:solid;border-color:rgba(0, 0, 0, 0.12);border-bottom-width:thin;margin-top:16px;margin-bottom:16px;}</style><hr class="MuiDivider-root MuiDivider-fullWidth css-1pjwakg"/><style data-emotion="css vqwd1x">.css-vqwd1x{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;}</style><div class="MuiBox-root css-vqwd1x"><style data-emotion="css 92vi8h">.css-92vi8h{margin:0;font-size:0.875rem;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;line-height:1.43;letter-spacing:0.01071em;color:rgba(0, 0, 0, 0.6);}@media (max-width:600px){.css-92vi8h{font-size:0.9rem;}}</style><p class="MuiTypography-root MuiTypography-body2 css-92vi8h">Â© <!-- -->2025<!-- --> BetweenSystems.</p></div><style data-emotion="css xpugnx">.css-xpugnx{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:0.75rem;line-height:1.66;letter-spacing:0.03333em;color:rgba(0, 0, 0, 0.6);margin-top:8px;display:block;font-style:italic;}</style><span class="MuiTypography-root MuiTypography-caption css-xpugnx">Powered by Next.js &amp; Material-UI</span></div></div></footer><style data-emotion="css c8086p">.css-c8086p{position:fixed;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;right:0;bottom:0;top:0;left:0;background-color:rgba(0, 0, 0, 0.5);-webkit-tap-highlight-color:transparent;color:#fff;z-index:1201;background:linear-gradient(135deg, rgba(0,92,191,0.9) 0%, rgba(0,112,243,0.9) 100%);}</style><div aria-hidden="true" class="MuiBackdrop-root css-c8086p" style="opacity:0;visibility:hidden"><style data-emotion="css xi606m">.css-xi606m{text-align:center;}</style><div class="MuiBox-root css-xi606m"><style data-emotion="css 15g1rm8 animation-61bdi0">.css-15g1rm8{display:inline-block;-webkit-animation:animation-61bdi0 1.4s linear infinite;animation:animation-61bdi0 1.4s linear infinite;margin-bottom:16px;}@-webkit-keyframes animation-61bdi0{0%{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}100%{-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-ms-transform:rotate(360deg);transform:rotate(360deg);}}@keyframes animation-61bdi0{0%{-webkit-transform:rotate(0deg);-moz-transform:rotate(0deg);-ms-transform:rotate(0deg);transform:rotate(0deg);}100%{-webkit-transform:rotate(360deg);-moz-transform:rotate(360deg);-ms-transform:rotate(360deg);transform:rotate(360deg);}}</style><span class="MuiCircularProgress-root MuiCircularProgress-indeterminate MuiCircularProgress-colorInherit css-15g1rm8" style="width:60px;height:60px" role="progressbar"><style data-emotion="css 4ejps8">.css-4ejps8{display:block;}</style><svg class="MuiCircularProgress-svg css-4ejps8" viewBox="22 22 44 44"><style data-emotion="css 13odlrs animation-1o38n3e">.css-13odlrs{stroke:currentColor;stroke-dasharray:80px,200px;stroke-dashoffset:0;-webkit-animation:animation-1o38n3e 1.4s ease-in-out infinite;animation:animation-1o38n3e 1.4s ease-in-out infinite;}@-webkit-keyframes animation-1o38n3e{0%{stroke-dasharray:1px,200px;stroke-dashoffset:0;}50%{stroke-dasharray:100px,200px;stroke-dashoffset:-15px;}100%{stroke-dasharray:1px,200px;stroke-dashoffset:-126px;}}@keyframes animation-1o38n3e{0%{stroke-dasharray:1px,200px;stroke-dashoffset:0;}50%{stroke-dasharray:100px,200px;stroke-dashoffset:-15px;}100%{stroke-dasharray:1px,200px;stroke-dashoffset:-126px;}}</style><circle class="MuiCircularProgress-circle MuiCircularProgress-circleIndeterminate css-13odlrs" cx="44" cy="44" r="20" fill="none" stroke-width="4"></circle></svg></span><style data-emotion="css 19tjl9i">.css-19tjl9i{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:1.25rem;line-height:1.6;letter-spacing:0.0075em;font-weight:500;}</style><h6 class="MuiTypography-root MuiTypography-h6 css-19tjl9i"></h6></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"slug":"fixing-concurrent-queries-within-the-same-session-in-clickHouse-async-python-apps","title":"Fixing Concurrent Queries Within the Same Session in ClickHouse Async Python Apps (Uvicorn + FastAPI)","date":"2025-10-16","tags":["Python","ClickHouse","Uvicorn","Concurrency","Architecture","DevOps"],"coverImage":"/images/ch1/cover.jpg","content":"\nConnecting to a database from Python seems simple enough - you create a client, send queries, and handle results. But when we scaled that to thousands of concurrent requests under an async web server, things got a bit more interesting.\n\nThis post walks through how we hit a classic concurrency issue in our ClickHouse integration - how it appeared, what caused it, the quick fix we applied, and finally how we designed a long-term scalable solution using an async connection pool.\n\n## The Setup\n\nOur backend service is a data ingestion API that pushes concurrent large JSON payloads into ClickHouse. It runs on top of [**Uvicorn**](https://uvicorn.dev/), an ASGI web server that handles requests asynchronously.\n\nWe used the official [clickhouse-connect](https://github.com/ClickHouse/clickhouse-connect) library to communicate with the database. In the beginning, the design looked clean and simple:\n\n```python\n# Simplified version of the initial design\n\nclass CB:\n\n    def __init__(self):\n        self.client = AsyncClient(\n            host=\"clickhouse_host\",\n            port=8123,\n            database=\"DB_NAME\",\n            username=\"default\",\n            password=\"default\"\n        )\n\n    async def post_raw(self, payload):\n        await self.client.insert(table=\"m_data\", data=payload)\n```\n\nWe created **a single AsyncClient instance** when the backend started - a singleton pattern. Every request reused this same client to perform queries, inserts and health checks.\n\nWe leveraged [ClickHouse's server-side asynchronous insert](https://clickhouse.com/docs/optimize/asynchronous-inserts) feature by configuring the insertion settings to use ***async_insert=1***. This setting is key for high-throughput ingestion, as it tells the [ClickHouse server to buffer and batch data internally](https://clickhouse.com/blog/asynchronous-data-inserts-in-clickhouse). However, as we soon discovered, server-side data handling being asynchronous does not guarantee client-side session safety.\n\n## The Problem Appears\n\nEverything was smooth in development and staging environments. It looked fine - until we hit production and started ingesting thousands of rows per minute, the logs exploded with the following message:\n\n\u003e ***Attempt to execute concurrent queries within the same session. Please use a separate client instance per thread/process.***\n\nThirty percent of the inserts began failing randomly under load. Some succeeded, others didn't. It wasn't deterministic - but it was bad.\n\n## The Role of Uvicorn and Async Concurrency\n\nOur API application runs on **Uvicorn** web server, which means requests are handled *asynchronously* on a single [event loop](https://uvicorn.dev/concepts/event-loop/) by the [*uvloop* library](https://github.com/MagicStack/uvloop).\n\nIn async Python, multiple [coroutines](https://docs.python.org/3/library/asyncio-task.html) (i.e., concurrent requests) share the same event loop and can all run at once when waiting on I/O. So even though we weren't using multiple OS threads (no parallelism), we achieved high concurrency within the same single-threaded process by efficiently switching between waiting requests.\n\nHere's what was happening under the hood:\n\n![img](/images/ch1/image_1.jpg)\n\nBecause all requests used the **same Clickhouse AsyncClient instance**, multiple coroutines tried to send different queries over the same underlying TCP session - at the same time. This scenario is a classic example of shared mutable state in an asynchronous environment. Multiple requests raced to use the same underlying socket before the previous query had finished, violating the database client's contract.\n\nClickHouse rightfully rejected this pattern. Its client session protocol doesn't support multiple concurrent queries per connection. Each query must complete before another begins on the same connection.\n\nIt's important to distinguish between ClickHouse's server-side asynchronous insert feature (async_insert=1) and our client-side asynchronous concurrency (Uvicorn/coroutine model). The server-side feature efficiently buffers the data. However, the client driver still requires a non-conflicting network session to send the insert request and receive the response (even if that response is a quick acknowledgement). Our problem was that multiple coroutines were attempting to initiate their separate insert operations over the single shared client session at the exact same moment, which the client/session protocol disallowed. The fix was necessary to resolve the session-level concurrency issue, not the server's data-buffering mechanism.\n\nThat's why the error message said:\n\n\u003e ***Please use a separate client instance per thread/process.***\n\nEven though we weren't using multiple threads, we had the same effect: concurrent use of a shared connection.\n\n## Quick Fix: One Client per Request\n\nWhen production fire alarms are ringing, elegance comes second.\n\nAs a **quick fix**, we changed our approach to create a **new ClickHouse client per request**.\n\n```python\nasync def post_data(self, payload):\n    async with AsyncClient(client=get_client(...)) as client:\n        await client.insert(...)\n```\n\nThat immediately solved the concurrency issue. Each request had its own isolated client - and therefore its own TCP session - avoiding shared-state problems completely.\n\nBut this (and probably most) quick solution came at a cost.\n\nCreating and closing a ClickHouse client for every single request is expensive. At large ingestion volumes, it increases connection setup overhead, authentication latency, and CPU churn on both the client and server sides.\n\nWe needed something more efficient.\n\n## The Final Fix: Connection Pooling\n\nOnce stability returned, we revisited the design.\n\nInstead of one global client or one-per-request, we moved to a **connection pool** - maintaining a fixed number of ready-to-use ClickHouse clients and reusing them efficiently.\n\n![img](/images/ch1/image_2.jpg)\n\n### New approach\n\n```python\nclass PooledClient:\n    \"\"\"Helper Context Manager Class\"\"\"\n\n    def __init__(self, pool, client):\n        self._pool = pool\n        self.client = client\n\n    async def __aenter__(self):\n        \"\"\"Called when 'async with' starts\"\"\"\n        return self.client\n\n    async def __aexit__(self, exc_type, exc_val, exc_tb):\n        \"\"\"\n        Called when 'async with' block ends (even on error).\n        For simplicity, we just return the client to the pool.\n        (You could add logic here to replace broken clients.)\n        \"\"\"\n        if not getattr(self.client, \"is_closed\", False):\n            await self._pool.put(self.client)\n        return False\n\n\nclass ClickhousePool:\n    \"\"\"Main Connection Pool Class\"\"\"\n\n    def __init__(self):\n        self._pool = asyncio.Queue(maxsize=SIZE)\n        for _ in range(SIZE):\n            client = AsyncClient(client=get_client(...))\n            self._pool.put_nowait(client)\n\n    async def get_client(self):\n        \"\"\"Returns a context manager object that handles the client lifecycle\"\"\"\n        return PooledClient(self._pool, await self._pool.get())\n\n    async def post_data(self, payload):\n        \"\"\"The Clean Consumption in the API\"\"\"\n        rows = ...  # transformations of payload\n        table_name = ...\n        columns = ...\n\n        async with self.get_client() as client:\n            await client.insert(\n                table=table_name,\n                data=rows,\n                column_names=columns,\n                settings={\n                    'async_insert': 1,\n                    'wait_for_async_insert': 0,\n                    # ... other settings\n                }\n            )\n```\n\nOnce the connection pool is in place, usage of async API is straightforward:\n\n```python\ncp = ClickhousePool()\nawait cp.post_data(payload)\n```\n\nWith the pooled design we make sure that, (1) each of the requests borrow a client from the pool, (2) they use it to execute a query or insert, (3) the client is released back into the pool afterward, (4) if a client breaks (due to a network or protocol error), it's replaced with a new one.\n\nThis hybrid approach provides safety by not sharing clients across concurrent requests, performance by avoiding recreate clients repeatedly, scalability by easily tune pool size to match workload.\n\n```txt\nSingleton        -\u003e  One global AsyncClient\nPer-request      -\u003e  New client per request\nConnection pool  -\u003e  Limited shared pool, reused safely\n```\n\n## Validation and Results\n\nOnce deployed, the difference was clear.\n\nWe validated the new behavior in three ways. Error messages related to ***concurrent queries within the same session*** disappeared completely. Connection metrics stabilized - fewer reconnections, more consistent query latencies. The ClickHouse row count graphs started growing linearly again - confirming ingestion pipelines were back to full capacity.\n\n## Lessons Learned\n\nOne of the key takeaways from this experience was realizing that asynchronous code isn't automatically thread-safe or concurrency-safe. Using async functions doesn't guarantee that shared resources can be accessed safely by multiple coroutines. In our case, reusing a single AsyncClient across concurrent requests seemed fine at first, but when multiple coroutines tried to use it simultaneously, it led to unexpected failures. The event loop can rapidly switch between these coroutines, and if the underlying resource isn't designed for concurrent access, it will eventually break - exactly as we saw with the ClickHouse client.\n\nWe also learned that Uvicorn's speed comes from concurrency, not parallelism. It multiplexes many requests on a single event loop in one process. That means even though the server feels lightweight and fast, all those requests are sharing the same runtime environment. Any global object - such as a database connection, HTTP session, or cache client - must be carefully managed to ensure it's concurrency-safe. The illusion of simplicity in async code can be deceptive; behind the scenes, coroutines are continuously yielding and resuming, which magnifies issues caused by shared mutable state.\n\nWhen production problems strike, it's often tempting to apply quick fixes to restore stability. We did the same by creating one client per request - a brute-force but effective short-term solution. It isolated each operation and immediately eliminated concurrency conflicts. However, that approach didn't scale well. Each new client meant an additional connection handshake, authentication cycle, and network setup overhead. It worked to stop the bleeding, but it wasn't efficient enough for a high-throughput ingestion system. A connection pool, on the other hand, gave us the right balance - isolation without excessive overhead.\n\nFinally, this journey reinforced that observability is critical. Without clear logs, metrics, and dashboards, it would have been nearly impossible to pinpoint the root cause or verify the effectiveness of our fix. Our Grafana dashboards, error logs, and ClickHouse ingestion metrics made it clear when the issue appeared, how severe it was, and how things stabilized after deploying the pooled solution. Good observability turned what could have been a long debugging marathon into a structured diagnosis and validation process.\n\n## Closing Thoughts\n\nThis issue was a great reminder that even high-level async code hides some deep concurrency challenges underneath.\n\nThe evolution - from a single shared client, to per-request isolation, to an efficient async connection pool - illustrates how understanding the **runtime model** (Uvicorn + async I/O) is just as important as writing correct business logic.\n"}},"__N_SSG":true},"page":"/[slug]","query":{"slug":"fixing-concurrent-queries-within-the-same-session-in-clickHouse-async-python-apps"},"buildId":"p3erRfV6NL6EPM2TJwJwU","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>